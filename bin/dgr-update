#!/bin/bash
#set -x
set -e
dir=$( dirname $0 )
command -v jq >/dev/null 2>&1 || { echo >&2 "I require jq but it's not installed. Aborting."; exit 1; }


platform="linux-amd64"

url_data=$(curl -s https://api.github.com/repos/blablacar/dgr/releases)
url=$(echo $url_data | jq -r -c '.[0].assets[] | select(.name | contains("'$platform'") ) |select(.browser_download_url| contains("tar.gz")).browser_download_url')
version=$(echo $url_data | jq -r -c '.[0].tag_name')

if [ -f "$dir/.last_dgr" ]; then
    last_dgr=`cat $dir/.last_dgr`
fi

if [ "$version" != "$last_dgr" ]; then
	wget -O ${dir}/dgr.tar.gz $url
	tar xvzf ${dir}/dgr.tar.gz -C ${dir}
	rm ${dir}/dgr.tar.gz
	echo $version > $dir/.last_dgr
fi
