#!/bin/bash
#set -x
set -e
dir=$( dirname $0 )

if [[ "$OSTYPE" =~ ^linux ]]; then
    platform="linux-amd64"
elif [[ "$OSTYPE" == "darwin"* ]]; then
    platform="darwin-amd64"
elif [[ "$OSTYPE" == "cygwin" ]]; then
    platform="windows-amd64"
elif [[ "$OSTYPE" == "msys" ]]; then
    platform="windows-amd64"
elif [[ "$OSTYPE" == "win32" ]]; then
    platform="windows-amd64"
else
    echo "Unknown platform"
    exit 1
fi

url_data=$(curl -s https://api.github.com/repos/blablacar/ggn/releases)
url=$(echo $url_data | jq -r -c '.[0].assets[] | select(.name | contains("'$platform'")).browser_download_url') 
version=$(echo $url_data | jq -r -c '.[0].name')
if [ -f "$dir/.last_ggn" ]; then
    last_ggn=`cat $dir/.last_ggn`
fi

if [ "$version" != "$last_ggn" ]; then
	wget -O ${dir}/green-garden.tar.gz $url
	tar xvzf ${dir}/green-garden.tar.gz --strip=1 -C ${dir}
	rm ${dir}/green-garden.tar.gz
	echo $version > $dir/.last_ggn
fi
